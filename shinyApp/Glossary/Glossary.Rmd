---
title: GLOSSARY
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    logo: iow_logo_horizontal_rgb.png
    theme: readable
runtime: shiny
---
<script>
$('.navbar-logo').wrap('<a href="http://internetofwater.org">');
</script>

<style type="text/css">

.chart-title {  /* chart_title  */
   font-size: 20px;
   font-family: "Arial",Sans-serif;
   color: #022949

}

                  
<!-- .navbar a { -->
<!--   color: white; -->
<!--   text-align: center; -->
<!--   text-decoration: none; -->
<!--   background-color: inherit; -->
<!-- } -->

.navbar-nav li a{
  background-color: #a1c6d5;

  }

<!-- .navbar-nav li a:focus{ -->
<!--   background-color: #a1c6d5; -->

<!--   } -->

<!-- .navbar-nav li a:active{ -->
<!--   background-color: #a1c6d5; -->

<!--   } -->

<!-- .navbar-nav li a:visited{ -->
<!--   background-color: #a1c6d5; -->

<!--   } -->


.navbar-inverse .nav-collapse .nav > li > a {
 font-size:40px;
}
</style>



```{r global, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(DT)
library(urltools)
#library(rdflib)
library(shinyWidgets)
#library(igraph)
library(SPARQL)
library(googledrive)
drive_auth_configure(api_key = "AIzaSyABmEVEPLtZkb2mziBaCc37pYFE5dHsDUU")
drive_auth(path="alien-craft-256317-ec852c98b4a0.json")


downloadButtonRmd <- function (outputId, label = "Download", class = NULL, ...)  {
     tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", 
        class), href = "", target = "_blank", download = NA, 
        icon("download"), label, ...)
 }

## big table
#g<-rdf_parse("glossary.ttl",format="turtle")
endpoint<-"http://35.238.222.96:7200/repositories/Glossary_core"
q<-'PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX : <http://purl.org/iow/Glossary/>

select ?uri ?Term ?Vocabulary ?voclink ?Organization ?Definition ?Theme  WHERE { 
	?uri a skos:Concept .
    ?uri skos:prefLabel ?Term .
    ?uri skos:definition ?Definition .
    ?uri skos:inScheme ?voc .
    ?voc skos:note ?voclink .
    ?voc skos:prefLabel ?Vocabulary .
    ?voc rdfs:isDefinedBy ?Org .
    ?Org skos:prefLabel ?Organization .
    ?Th skos:member ?uri .
    ?Th skos:prefLabel ?Theme
}'

data<-SPARQL(endpoint,q,format="csv")$results
data[] <- lapply(data, as.character)

Terms<-distinct(data[c("uri","Term","Vocabulary")])%>%arrange(Term)
Terms$Term<-paste0(Terms$Term," (",Terms$Vocabulary,")")
data$Vocabulary <- paste0('<a href=', data$voclink,' target="_blank" rel="noopener"','>',data$Vocabulary,'</a>')
data$Term <- paste0(data$Term,'<a href=', data$uri,' target="_blank" rel="noopener"','> ',as.character(icon("share", lib = "glyphicon")),'</a>')
data<-data[c("uri","Term","Definition","Vocabulary","voclink","Organization","Theme")]



```




Main Term Browser
=====================================  

Column {data-width=650}
-----------------------------------------------------------------------

### Main Table of Terms
<h5>Filter by Theme and/or Organization. Click rows to view synonyms and related terms on the right.</h5>

```{r}

ch<-unique(data[order(data$Theme),]$Theme)
ch<-c(ch,"Other")
data$Theme[which(is.na(data$Theme))]<-"Other"
d <- reactive({
  data%<>%filter(Theme %in% input$filter & Organization %in% input$filter2  )%>%arrange(Term)%>%distinct(uri,.keep_all=T)
})


fluidRow(column(1,pickerInput(
   inputId = "filter",
   #label = "Theme(s)",
    choices = ch,
   selected= ch,
   multiple=TRUE, width=300, options = list(
      `actions-box` = TRUE, `selected-text-format`='static',`title`="Select Theme(s)")
),offset=1),
column(1,pickerInput(
   inputId = "filter2",
 #  label = "Organizations(s)",
    choices = unique(data[order(data$Organization),]$Organization),
   selected=unique(data[order(data$Organization),]$Organization),
   multiple=TRUE, width=300, options = list(
      `actions-box` = TRUE, `selected-text-format`='static',`title`="Select Organization(s)")
),offset=3))




#d2 <- reactive({d()[c("Concept","Definition")]})

output$table = DT::renderDataTable({
  DT::datatable(d(), options = list(columnDefs = list(list(targets = c(0,4,5,6), visible = FALSE),list(targets=c(0,3,4,5,6),searchable=FALSE)),
    dom='Bti', buttons = list(list(extend = 'csv', filename= 'main_table')),bPaginate=FALSE,scrollY='55vh',searchHighlight = TRUE), rownames=FALSE, escape=FALSE, selection="single", extensions = c('Buttons','FixedHeader'), filter="top"
  )
})

DT::dataTableOutput('table')

#, scrollY = '65vh')


```



Column {data-width=350}
-----------------------------------------------------------------------

### Synonyms of selected term


```{r}
 s = reactive({as.character(d()[input$table_rows_selected,"uri"])})
 synparse<-reactive({paste0('PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX : <http://purl.org/iow/Glossary/>
select ?uri where{
    <',s(), '> skos:exactMatch ?uri
}')})
 syn_uris<-reactive({SPARQL(endpoint,synparse(),format="csv")$result$uri})

 syn_d<-reactive({data<-data%>%filter(uri %in% syn_uris())})


 output$syntable = DT::renderDataTable({
   DT::datatable(syn_d(), extensions = c('Buttons','Responsive'),options = list(columnDefs = list(list(targets = c(0,4,5,6), visible = FALSE),list(targets=c(0,3,4,5,6),searchable=FALSE)),
     dom='Bt', buttons = list(list(extend = 'csv', filename= paste0('synonyms','_',substr(s(),nchar(s())-10,nchar(s()))))),"pageLength" = 5000,scrollY='70vh'), rownames=FALSE, escape=FALSE, selection="single"
   )
 })

DT::dataTableOutput('syntable')


```

Help Identify Synonyms
=====================================  



Column {data-width=650}
-----------------------------------------------------------------------

### Propose Synonyms

A number of vocabularies of different organizations are rerpresented in this glossary. We need help identifying which terms have synonymous definitions across these vocabularies.

<h5>Step 1: Search and select concepts for which to identify synonyms</h5>

```{r}
fluidRow(column(1,pickerInput(
   inputId = "search",
  # label = "Search Terms (with source vocabulary)", 
   width=600,
    choices = Terms$Term,
  selected=NULL,
options = list(  size = 10, `live-search` = TRUE)
)

,offset=1))

selected_uri<-reactive({as.character(Terms$uri[which(Terms$Term == input$search)])})
```

<h5>Step 2. Click all rows corresponding to concepts you believe are synonymous with the concepts selected in Step 1.</h5> The glossary has provided the 50 terms with the most commonality in the word content of definitions ("score")  to the selected concept, as well as all other concepts in the glossary associated with the same term (i.e. homonyms).
```{r}

endpoint_sim<-"http://35.238.222.96:7200/repositories/Synonym_search"

sel_parse<-reactive({paste0('PREFIX :<http://www.ontotext.com/graphdb/similarity/>
PREFIX inst:<http://www.ontotext.com/graphdb/similarity/instance/>
PREFIX pubo: <http://ontology.ontotext.com/publishing#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

SELECT ?uri ?Term ?Definition ?Vocabulary ?score {
    ?search a inst:definition_text_similarity ;
        :searchDocumentID <',selected_uri(), '>;
        :searchParameters "-numsearchresults 50";
        :documentResult ?result .
    ?result :value ?uri ;
            :score ?score.
    ?uri skos:prefLabel ?Term .
    ?uri skos:definition ?Definition .
    ?uri skos:inScheme ?voc .
    ?voc skos:prefLabel ?Vocabulary .
}')})
#sel_uris<-reactive({SPARQL(endpoint_sim,sel_parse(),format="csv")$result%>%mutate(score=round(score,2))})

hom_parse<-reactive({paste0('PREFIX :<http://www.ontotext.com/graphdb/similarity/>
PREFIX inst:<http://www.ontotext.com/graphdb/similarity/instance/>
PREFIX pubo: <http://ontology.ontotext.com/publishing#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

SELECT ?uri ?Term ?Definition ?Vocabulary ?score {
    ?search a inst:term_similarity ;
        :searchDocumentID <',selected_uri(), '>;
        :searchParameters "-numsearchresults 100";
        :documentResult ?result .
 ?result :value ?uri ;
            :score ?score.
    ?uri skos:prefLabel ?Term .
    ?uri skos:definition ?Definition .
    ?uri skos:inScheme ?voc .
    ?voc skos:prefLabel ?Vocabulary .
    FILTER(?score >= 0.5)
}')})
#hom_uris<-reactive({SPARQL(endpoint_sim,hom_parse(),format="csv")$result%>%mutate(score=round(score,2))})

uris<-reactive({bind_rows(SPARQL(endpoint_sim,sel_parse(),format="csv")$result%>%mutate(score=round(score,2),Term=paste0(Term," (",Vocabulary,")")),SPARQL(endpoint_sim,hom_parse(),format="csv")$result%>%mutate(score=round(score,2),Term=paste0(Term," (",Vocabulary,")")))%>%distinct(uri,.keep_all=TRUE)%>%arrange(-score)})

 output$seltable = DT::renderDataTable({
   DT::datatable(uris(),options = list(columnDefs = list(list(targets = c(0,3), visible = FALSE)),dom='ti',ordering=F,"pageLength" = 5000,scrollY='55vh',buttons = list(list(extend = 'csv', filename= paste0('synonyms_submit')))), rownames=FALSE, escape=FALSE, selection="multiple"
   )
 })

DT::dataTableOutput('seltable')

```



Column {data-width=350}
-----------------------------------------------------------------------
### Review synoynms

<h5>Step 3. Review and submit synonym suggestions</h5>


```{r}

#print(reactive({input$seltable_rows_selected}))
sel_syn = reactive({distinct(uris()[c(1,input$seltable_rows_selected),])})

 output$selsyn = DT::renderDataTable({
   DT::datatable(sel_syn(), extensions = c('Buttons','Responsive'),options = list(columnDefs = list(list(targets = c(0,3,4), visible = FALSE)),
     dom='it', buttons = list(list(extend = 'csv', filename= paste0('synonyms_submit'))),"pageLength" = 5000,scrollY='70vh'), rownames=FALSE, escape=FALSE, selection="single"
   )
 })

DT::dataTableOutput('selsyn')
#
library(shinyLP)


```


Column {data-width=350}
-----------------------------------------------------------------------
### Submit proposed synoynms

<h5>Step 4. Submit synonym suggestions</h5>
Once you have reviewed your choices of synonyms, please provide your name and email address and what organization you represent. Then, click the blue button below to submit!

```{r}

#print(drive_ls())


textInput("nameInput", "Last name, First name")
textInput("emailInput", "E-mail address")
textInput("orgInput", "Organization")

actionBttn(
   inputId = "do2",
   label = "Submit Proposed Synonyms", 
    style = "fill",
   color = "primary"
)


textOutput("text")
verbatimTextOutput("name")
verbatimTextOutput("email")

#name<-reactive({as.character(paste0("Glossary_Resources/Synonym_Proposal_Sheets/",selected_uri(),"_",".csv"))})


 observeEvent(input$do2, {
   #name<-paste0("Glossary_Resources/Synonym_Proposal_Sheets/",selected_uri(),"_",".csv")
  write.csv(cbind(sel_syn(),input$nameInput,input$emailInput,input$orgInput),"synonyms.csv")
  upload <- drive_upload("synonyms.csv",paste0("Glossary_Resources/Synonym_Proposal_Sheets/synonyms_submit_",nrow(drive_ls("Glossary_Resources/Synonym_Proposal_Sheets")),".csv"),type="spreadsheet")
    output$text<-renderText({"Thank you for your contribution! Please feel free to submit more by starting at Step 1 again."})
    
  })
```


Submit Your Vocabulary
=====================================  

Column 
-----------------------------------------------------------------------

### Submit your vocabulary

<p style="font-size: 18px">We are in the process of collecting vocabularies in use by public water resources and quality agencies, NGOs, and private-sector organizations across the country. If you did not see your organization's vocabulary/ies represented in our Main Term Browser tab, please consider contributing a vocabulary to our Glossary! </p>


<p style="font-size: 18px">[Click here to contribute](https://ee.kobotoolbox.org/i/::BQ2kodoV)</p>

